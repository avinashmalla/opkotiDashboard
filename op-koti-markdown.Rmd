---
title: "op-koti"
output:
  pdf_document: default
  html_document: default
---

*This file takes data manipulated in the python script and prepares it further for the shiny dashboard*


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Packages**
```{r}
suppressPackageStartupMessages({
  library(ggplot2)
  library(plotly)
  library(tidyverse)
  library(magrittr)
  library(ggrepel)
  library(repr)
  library(gridExtra)
  library(ggpubr)
})
```

**Read Data**

```{r}
df <- read.csv('op-koti.csv',
               stringsAsFactors = F,
               colClasses = c("character", "character", "integer", "integer", "numeric", "numeric", "character", "character", "character", "character", "numeric", "numeric", "numeric", "integer", "integer", "integer", "integer", "integer", "integer")
)
head(df)
```


**Check for NAs. It should not contain any because it's already been cleaned**
```{r}
any(is.na(df))
```

**Creating new variables for price per meter square and link to the respective houses on the website**
```{r}
df <- df %>%
  mutate(pricePMsq = debtFreePrice/totalArea, link = paste0("<a href='https://op-koti.fi/kohde/",id,"'>","https://op-koti.fi/kohde/",id,"</a>"))
```

**A bit more of housekeeping. Checking the listing types**
```{r}
table(df$listingType)
```

Merging 'Kytketty paritalo' into 'Paritalo'
```{r}
df$listingType[df$listingType %in% "Kytketty paritalo"] <- "Paritalo"
table(df$listingType)
```

Rearranging columns
```{r}
i=1
for (item in colnames(df)){
  #     sprintf(“%d : %d”, i, item)
  print(paste(i,':',item))
  i = i + 1
}
```
```{r}
df <- df[c(1,2,4,5,6,11,12,20,7:10,3,13:19,21)]
head(df)
```

#### Let's plot some graphs using the data
Let's take only the **ten most populated municipalities** in Finland. They are Helsinki, Espoo, Tampere, Vantaa, Oulu, Turku, Jyväskylä, Kuopio, Lahti, Pori (in decreasing order of population)

```{r}
big_cities <- list('Helsinki', 'Espoo', 'Tampere', 'Vantaa', 'Oulu', 'Turku', 'Jyväskylä', 'Kuopio', 'Lahti', 'Pori')
```

**Average price per meter squared when properties are in or outside the city center**

```{r fig.align="center", fig.width = 14, fig.height = 8}
pl1 <- df %>%
  filter(centrum == 1 & city %in% big_cities) %>%
  group_by(city) %>%
  summarize(AvgPricePMsq = mean(pricePMsq, na.rm = T)) %>%
  # ggplot(aes(x = reorder(city, -AvgPricePMsq), y = AvgPricePMsq, fill = city)) +
  ggplot(aes(x = city, y = AvgPricePMsq, fill = city)) +
  geom_bar(stat = 'identity') +
  xlab('City') + ylab('Average price per meter sq') +
  geom_text(aes(label = round(AvgPricePMsq,2)), size = 4, position = position_stack(vjust = 1), angle = 45) +
  ggtitle("Average Price per sq meters IN city centers in 10 big cities") +
  theme(axis.text.x = element_text(angle = 90), plot.title = element_text(size = 12, face = "bold"), legend.position = 'none')

pl2 <- df %>%
  filter(centrum == 0 & city %in% big_cities) %>%
  group_by(city) %>%
  summarize(AvgPricePMsq = mean(pricePMsq, na.rm = T)) %>%
  # ggplot(aes(x = reorder(city, -AvgPricePMsq), y = AvgPricePMsq, fill = city)) +
  ggplot(aes(x = city, y = AvgPricePMsq, fill = city)) +
  geom_bar(stat = 'identity') +
  xlab('City') + ylab('Average price per meter sq') +
  geom_text(aes(label = round(AvgPricePMsq,2)), size = 4, position = position_stack(vjust = 1), angle = 45) +
  ggtitle("Average Price per sq meters OUTSIDE city centers in 10 big cities") + 
  theme(axis.text.x = element_text(angle = 90), plot.title = element_text(size = 12, face = "bold"), legend.position = 'none')

gt <- arrangeGrob(pl1, pl2, ncol = 2)
# Transform to a ggplot and print
as_ggplot(gt)
```

<!-- It seems that average price per sq. m. is almost double when the property is in the city center rather than when it's not. WRITE A SUMMARY OF THE GRAPH -->

**Now let's take a look at the types of houses listed**
```{r}
df %>%
  # filter(city %in% big_cities) %>%
  group_by(listingType) %>%
  summarise(freq = n()) %>% # freq table for types of houses
  mutate(fraction = freq/sum(freq), # percentages
         ymax = cumsum(fraction), #cumulative percentages (top of each rectangle)
         ymin = c(0, head(ymax, n = -1)), #bottom of each rectangle
         
         labelPosition = (ymax + ymin) / 2, #position of the label
         label = paste0(listingType, ":", round(fraction*100,1),"%") #label
  ) %>%
  ggplot(aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=listingType)) +
  geom_rect() +
  geom_text(x=3.8, aes(y=labelPosition, label=label), color='black', size=4) + # x here controls label position (inner / outer)
  scale_fill_brewer(palette = 'Set1') +
  coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
  xlim(c(2, 4)) + # Try to remove that to see how to make a pie chart
  theme_void() +
  ggtitle('Types of houses')+
  theme(legend.position = "none")
```

The majority of properties are Kerrostalo, Rivitalo or Omakotitalo



**save the data to csv file for dashboard**
```{r}
write.csv(df, "/Users/avinashmalla/GitHub/opKotiDashboard/forDash.csv", row.names = F)
```

```{r}
glimpse(df)
```
